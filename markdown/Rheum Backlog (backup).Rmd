---
title: "Auditing the Rheumatology Backlog"
author: "Dominik Kurzeja"
date: "26/11/2021"
output: pdf_document
latex_engine: xelatex
mainfont: "Helvetica Light"
sansfont: "Helvetica Light"
seriffont: "Helvetica Light"
fontsize: 12pt
---
\fontfamily{phv}
\fontsize{12}{22}
\fontseries{m}
\selectfont

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(knitr)
library(rstatix)
library(gtsummary)
library(labelled)
library(extrafont)
```

## Auditing the Backlog

We have now completed three audit cycles of the Rheumatology outpatients backlog - based on the "status date" (or date of last encounter) of the patients waiting for follow up appointments on the 17th September (*C1*), 17th October 2021 (*C2*) and 17th November 2021 (*C3*).

This is the raw data for this - abbreviated to just include the number of patients with a status date between in the 13 month May 2020 - May 2021 period of interest.

```{r echo = FALSE, warning=FALSE}

#Data Import ----
dat <- read.csv("data_raw.csv") %>% filter(!is.na(month))
dat <- dat %>% mutate(date = make_date(year,month))

##Constructing required tables ----
audit <- dat %>% 
  pivot_wider(
    names_from = "cycle", 
    names_prefix = "C", 
    values_from = patients )

#table wtih the delta
audit <- audit %>% mutate(delta = C2 - C1)

#filter for period of interest
audit20 <- audit %>% filter(between(date,as_date("2020-05-01"), as_date("2021-05-01")))
#creating a seperate table used in the statistical analysis
auditstats <- dat %>% select(patients, cycle)

#formatting the dates correctly
audit20 <- audit %>% filter(between(date,as_date("2020-05-01"), as_date("2021-05-01")))

audit20prev <- audit20 %>% select(mon, year, C1, C2, C3)

kable(audit20prev)
```



## Graphs

We can visually represent the number of patients left on the backlog in each month of the period using a ridge-line plot, which also shows how this has reduced over each cycle of the audit: 

```{r echo=FALSE}

audit20ridge <- ggplot(audit20, aes(x = date)) + 
  geom_area(aes(y = C1, fill = "1")) + 
  geom_area(aes(y = C2, fill = "2")) + 
  geom_area(aes(y = C3, fill = "3")) + 
  labs(y = "Patients", fill = "Cycle")

audit20ridge

```


## Statistics

We can explore whether the change in the number of patients on the backlog during this period is statistically significant in a couple of different ways.

### Comparing across months

Firstly a **Wilcoxon Sign Rank** test (for multiple groups of non-parametric data) on the dataset, comparing the number of patients in each month in the first, second and third cycles of the audit:

Firstly an unpaired test:

``` {r echo =FALSE, warning=FALSE}

wilres <- wilcox_test(auditstats, patients ~ cycle)
kable(wilres)
```

And a paired test:

``` {r echo =FALSE, warning=FALSE}
wilpaires <- pairwise_wilcox_test(auditstats, patients ~ cycle)
kable(wilpaires)

```

This shows that there is no statistically significant difference between the medians and distribution of patients between months in the May 20 - May 21 period when the number of patients in each month is listed seperately.

### Comparing the total number of patients

An alternative method is to compare the *total* number of patients on the backlog at the time of each of the three cycles; this is an effective comparison of the "area under the curve" at each of these time points ("C1", "C2" and "C3"). 

```{r echo=FALSE, warning=FALSE}
#calculate the totals for each cycle
chistats <- dat %>% pivot_wider(names_from = "cycle", names_prefix = "C", values_from = patients) %>% filter(!is.na(C3))
chistotals <- chistats %>% select (C1:C3)  %>% summarise(C1 = sum(C1), C2 = sum(C2), C3 = sum(C3))

kable(chistotals)
```

This can be performed with a **Chi-squared* test:

Unpaired test:
```{r echo=FALSE, warning=FALSE}

#unpaired test
chires_totals <- chisq_test(chistotals)
kable(chires_totals)
kable(chisq_descriptives(chires_totals))
```


Pairwise comparison:
```{r echo=FALSE, warning=FALSE}
#pairwise test
chipaires <- pairwise_chisq_gof_test(chistotals)
kable(chipaires)
```

Therefore there is a statistically significant difference between the number of the patients on the backlog during this period at each of the three time points.

### Testing for trend

Additionally we can calculate the **Cochran-Armitage test** (a Chi-squared test for linear trends in changing proportions) with the assumption of the same proportion of patients in each month in each cycle:

First construct a table:

```{r echo = FALSE}

#creating a better summary table using unite to create a 'monyear' column
 datsummary <- chistats %>% unite(monyear, mon, year, sep = " ", remove = TRUE) %>% mutate(aud_mon = row_number()) %>% select(!month)
 
 datsummary <- set_variable_labels(datsummary, monyear = "Month")
 
trendaudit <- rbind(c(datsummary$C1), c(datsummary$C2), c(datsummary$C3))

dimnames(trendaudit) <- list(
  cycle = c("C1", "C2", "C3"),
  month = c(datsummary$monyear))

trendaudit <- t(trendaudit)
kable(trendaudit)
```

Then we perform the test:

```{r echo=FALSE}

trendres <- trendaudit %>% prop_trend_test( score = c(1:13))
kable(trendres)
```

This shows a highly statistically significant possible linear association between cycle and patients in each month


